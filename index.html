<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Simulateur de Perte Auditive</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 40px; background-color: #f4f4f4; }
    h1 { margin-bottom: 10px; }
    .sliders { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px; margin-bottom: 20px; }
    .slider-block { background: #fff; padding: 10px; border: 1px solid #ccc; text-align: center; }
    input[type=range] { width: 100%; }
    button { padding: 10px 20px; font-size: 16px; margin-right: 10px; margin-top: 10px; }
    select { font-size: 16px; padding: 5px; margin-bottom: 15px; }
  </style>
</head>
<body>

<h1>Simulateur de Perte Auditive</h1>
<p>Réglez les seuils d'audition (en dB HL) pour chaque fréquence :</p>
<div class="sliders">
  <div class="slider-block"><label>250 Hz<br><input type="range" min="0" max="100" value="0" id="f250"></label><div id="v250">0 dB</div></div>
  <div class="slider-block"><label>500 Hz<br><input type="range" min="0" max="100" value="0" id="f500"></label><div id="v500">0 dB</div></div>
  <div class="slider-block"><label>1000 Hz<br><input type="range" min="0" max="100" value="0" id="f1000"></label><div id="v1000">0 dB</div></div>
  <div class="slider-block"><label>2000 Hz<br><input type="range" min="0" max="100" value="0" id="f2000"></label><div id="v2000">0 dB</div></div>
  <div class="slider-block"><label>4000 Hz<br><input type="range" min="0" max="100" value="0" id="f4000"></label><div id="v4000">0 dB</div></div>
  <div class="slider-block"><label>8000 Hz<br><input type="range" min="0" max="100" value="0" id="f8000"></label><div id="v8000">0 dB</div></div>
</div>

<label for="audioSelector">Choisissez un extrait sonore :</label>
<select id="audioSelector" onchange="changeAudio(this.value)">
  <option value="https://www2.cs.uic.edu/~i101/SoundFiles/taunt.mp3">Voix de femme - calme</option>
  <option value="https://www2.cs.uic.edu/~i101/SoundFiles/CantinaBand3.mp3">Voix dans un restaurant</option>
  <option value="https://www2.cs.uic.edu/~i101/SoundFiles/BabyElephantWalk60.mp3">Voix d'enfant - calme</option>
</select><br>

<button onclick="initAndPlay('normal')">Écoute normale</button>
<button onclick="initAndPlay('filtered')">Écoute simulée</button>

<script>
const freqs = [250, 500, 1000, 2000, 4000, 8000];
let audioContext;
let selectedAudioUrl = document.getElementById('audioSelector').value;
let currentSource = null;

freqs.forEach(f => {
  document.getElementById('f' + f).addEventListener('input', () => {
    document.getElementById('v' + f).innerText = document.getElementById('f' + f).value + ' dB';
  });
});

function changeAudio(file) {
  selectedAudioUrl = file;
  stopAudio();
}

function stopAudio() {
  if (currentSource) {
    try { currentSource.stop(); } catch (e) {}
    currentSource.disconnect();
    currentSource = null;
  }
}

async function initAndPlay(mode) {
  stopAudio();
  if (!audioContext || audioContext.state === 'closed') {
    audioContext = new AudioContext();
  } else if (audioContext.state === 'suspended') {
    await audioContext.resume();
  }

  const response = await fetch(selectedAudioUrl);
  const arrayBuffer = await response.arrayBuffer();
  const audioBuffer = await audioContext.decodeAudioData(arrayBuffer);
  const source = audioContext.createBufferSource();
  source.buffer = audioBuffer;
  currentSource = source;

  if (mode === 'normal') {
    source.connect(audioContext.destination);
  } else {
    const filters = freqs.map(f => {
      const gain = -parseFloat(document.getElementById('f' + f).value);
      const filter = audioContext.createBiquadFilter();
      filter.type = 'peaking';
      filter.frequency.value = f;
      filter.Q.value = 1.5;
      filter.gain.value = gain;
      return filter;
    });
    filters.reduce((prev, curr) => {
      prev.connect(curr);
      return curr;
    });
    filters[filters.length - 1].connect(audioContext.destination);
    source.connect(filters[0]);
  }

  source.start();
}
</script>

</body>
</html>
